{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4>Payment Details</h4>
                </div>
                <div class="card-body">
                    <h5 class="card-title mb-4">Due Payment for {{ due.borrow.book.title }}</h5>
                    
                    <table class="table table-bordered">
                        <tr>
                            <th>Book Title:</th>
                            <td>{{ due.borrow.book.title }}</td>
                        </tr>
                        <tr>
                            <th>Due Date:</th>
                            <td>{{ due.borrow.due_date|date:"Y-m-d" }}</td>
                        </tr>
                        <tr>
                            <th>Days Overdue:</th>
                            <td>{{ due.borrow.return_date|timeuntil:due.borrow.due_date }}</td>
                        </tr>
                        <tr>
                            <th>Fine Amount:</th>
                            <td>â‚¹{{ due.amount }}</td>
                        </tr>
                    </table>
                    
                    <div class="text-center mt-4">
                        <button id="rzp-button" class="btn btn-primary">Pay Now</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    var options = {
        "key": "{{ razorpay_key }}",
        "amount": "{{ amount }}",
        "currency": "{{ currency }}",
        "name": "NITK Library",
        "description": "Due Payment for {{ due.borrow.book.title }}",
        "order_id": "{{ order_id }}",
        "handler": function (response){
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ callback_url }}";
            
            var fields = {
                'razorpay_payment_id': response.razorpay_payment_id,
                'razorpay_order_id': response.razorpay_order_id,
                'razorpay_signature': response.razorpay_signature
            };
            
            for(var key in fields) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            form.submit();
        },
        "prefill": {
            "name": "{{ student_name }}",
            "email": "{{ student_email }}",
            "contact": "{{ student_contact }}"
        },
        "theme": {
            "color": "#3399cc"
        }
    };
    
    var rzp = new Razorpay(options);
    
    document.getElementById('rzp-button').onclick = function(e){
        rzp.open();
        e.preventDefault();
    }
</script>
{% endblock %}